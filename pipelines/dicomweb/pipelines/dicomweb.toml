# ------------------------
# DICOMweb endpoint example
#-------------------------
[pipelines.dicomweb_demo]
description = "DICOMweb QIDO-RS and WADO-RS endpoint with medical imaging security policies"
networks = ["default"]
endpoints = ["dicomweb_endpoint"]
middleware = [
    "dicomweb_bridge",
    "imaging_security",
]
backends = ["dicom_pacs"]

# ------------------------
# Endpoints
#-------------------------
[endpoints.dicomweb_endpoint]
service = "dicomweb"
[endpoints.dicomweb_endpoint.options]
path_prefix = "/dicomweb"

# ------------------------
# DICOM Backend (DIMSE target for bridged requests)
#-------------------------
[backends.dicom_pacs]
service = "dicom_scu"
target_ref = "orthanc"  # Uses target definition from config.toml
[backends.dicom_pacs.options]
aet = "ORTHANC"
local_aet = "HARMONY_SCU"

# ------------------------
# Middleware
#-------------------------
[middleware.dicomweb_bridge]
type = "dicomweb_bridge"

# Medical Imaging Security Policies (References policies by ID)
# Production-grade access control for DICOMweb endpoints handling large imaging payloads
[middleware.imaging_security]
type = "policies"

[middleware.imaging_security.options]
policies = ["dicomweb_security"]

# ------------------------
# Policies
#-------------------------
[policies.dicomweb_security]
id = "dicomweb_security"
name = "DICOMweb Imaging Security"
enabled = true
rules = ["medical_networks", "dicomweb_paths", "rate_limit", "method_filter"]

# ------------------------
# Rules
#-------------------------
[rules.medical_networks]
id = "medical_networks"
name = "Allow Medical Networks Only"
type = "ip_allow"
weight = 90
enabled = true

[rules.medical_networks.options]
ip_addresses = [
    "10.0.0.0/8",       # Private network - Class A (hospital PACS)
    "172.16.0.0/12",    # Private network - Class B (imaging centers)
    "192.168.0.0/16",   # Private network - Class C (radiology departments)
    "127.0.0.1/32"      # Localhost (development/testing)
]

[rules.dicomweb_paths]
id = "dicomweb_paths"
name = "Allow DICOMweb Standard Paths"
type = "path"
weight = 85
enabled = true

[rules.dicomweb_paths.options]
paths = [
    "/studies/{*path}",     # DICOMweb studies endpoint
    "/series/{*path}",      # DICOMweb series endpoint (if used)
    "/instances/{*path}",   # DICOMweb instances endpoint (if used)
]
mode = "allow"

[rules.rate_limit]
id = "rate_limit"
name = "Rate Limit 20/minute (Large Payloads)"
type = "rate_limit"
weight = 50
enabled = true

[rules.rate_limit.options]
max_requests = 20
window_seconds = 60

[rules.method_filter]
id = "method_filter"
name = "Allow DICOMweb Methods"
type = "method"
weight = 80
enabled = true

[rules.method_filter.options]
mode = "allow"
methods = ["GET", "POST"]

# Medical imaging security rationale:
# - Lower rate limits (20/min) accommodate large payload sizes (DICOM images)
# - IP allowlisting ensures access only from trusted medical networks
# - Path filtering restricts to DICOMweb standard endpoints
# - Method restrictions align with DICOMweb protocol (GET for queries/retrieval, POST for storage)
# - All imaging access should be logged for compliance and audit trails

# ------------------------
# Middleware Type Registrations
#-------------------------

[middleware_types.dicomweb_bridge]
module = ""

