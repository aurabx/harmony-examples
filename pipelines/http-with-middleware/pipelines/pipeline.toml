# ==============================================================================
# Comprehensive Smoketest Pipeline
# ==============================================================================
# This pipeline exercises all major Harmony middleware types in a single flow.
#
# Request Flow:
# 1. HTTP request arrives → fhir_endpoint
# 2. Basic authentication check
# 3. Access control policies (IP allow, rate limiting, method/content-type filters)
# 4. Path filter (only /api/* allowed)
# 5. JSON extraction from request body
# 6. Transform request data (add metadata, restructure)
# 7. Forward to backend → http_backend
# 8. Transform response data
# 9. Return to client
#
# Test Commands:
# 
# ✅ Valid request (should succeed):
#   curl -X POST http://localhost:8080/api/transform \
#     -u testuser:testpass \
#     -H "Content-Type: application/json" \
#     -d '{"name": "John Doe", "id": "12345"}'
#
# ❌ Invalid path (should 404):
#   curl http://localhost:8080/invalid/path
#
# ❌ Invalid method (should 403):
#   curl -X DELETE http://localhost:8080/api/transform
#
# ❌ Invalid content type (should 403):
#   curl -X POST http://localhost:8080/api/transform \
#     -H "Content-Type: text/plain" \
#     -d "plain text"
# ==============================================================================

[pipelines.example]
description = "Comprehensive example with middleware"
networks = ["default"]
endpoints = ["http_api"]
middleware = [
    "basic_auth",
    "access_policies",
    "path_filter",
    "json_extractor",
    "request_transform",
    "passthru",
    "response_transform",
]
backends = ["backend_server"]

# ==============================================================================
# MIDDLEWARE - BASIC AUTHENTICATION
# ==============================================================================

[middleware.basic_auth]
type = "basic_auth"

[middleware.basic_auth.options]
username = "testuser"
password = "testpass"
token_path = "./tmp/example_token"

# ==============================================================================
# MIDDLEWARE - ACCESS CONTROL POLICIES
# ==============================================================================

[middleware.access_policies]
type = "policies"

[middleware.access_policies.options]
policies = ["api_security"]

# ==============================================================================
# MIDDLEWARE - PATH FILTER
# ==============================================================================

[middleware.path_filter]
type = "path_filter"

[middleware.path_filter.options]
rules = [
    { allow = "/api/{*path}" },      # Allow all /api/* paths
    { allow = "/health" },            # Allow health check
    { deny = "/{*rest}" }             # Deny everything else
]

# ==============================================================================
# MIDDLEWARE - JSON EXTRACTION
# ==============================================================================

[middleware.json_extractor]
type = "json_extractor"

# ==============================================================================
# MIDDLEWARE - REQUEST TRANSFORM
# ==============================================================================

[middleware.request_transform]
type = "transform"

[middleware.request_transform.options]
spec_path = "request_transform.json"
apply = "left"  # Apply to request
fail_on_error = false

# ==============================================================================
# MIDDLEWARE - PASSTHRU (for compatibility)
# ==============================================================================

[middleware.passthru]
type = "passthru"

# ==============================================================================
# MIDDLEWARE - RESPONSE TRANSFORM
# ==============================================================================

[middleware.response_transform]
type = "transform"

[middleware.response_transform.options]
spec_path = "response_transform.json"
apply = "right"  # Apply to response
fail_on_error = false

# ==============================================================================
# POLICIES
# ==============================================================================

[policies.api_security]
id = "api_security"
name = "API Security Policy"
enabled = true
rules = [
    "allow_localhost",
    "rate_limit",
    "content_type_filter",
    "method_filter"
]

# ==============================================================================
# RULES
# ==============================================================================

[rules.allow_localhost]
id = "allow_localhost"
name = "Allow Localhost and Private Networks"
type = "ip_allow"
weight = 100
enabled = true

[rules.allow_localhost.options]
ip_addresses = [
    "127.0.0.1/32",
    "10.0.0.0/8",
    "172.16.0.0/12",
    "192.168.0.0/16"
]

[rules.rate_limit]
id = "rate_limit"
name = "Rate Limit 50/minute"
type = "rate_limit"
weight = 50
enabled = true

[rules.rate_limit.options]
max_requests = 50
window_seconds = 60

[rules.content_type_filter]
id = "content_type_filter"
name = "Allow JSON Only"
type = "content_type"
weight = 80
enabled = true

[rules.content_type_filter.options]
mode = "allow"
content_types = ["application/json"]

[rules.method_filter]
id = "method_filter"
name = "Allow POST and GET Only"
type = "method"
weight = 85
enabled = true

[rules.method_filter.options]
mode = "allow"
methods = ["GET", "POST"]

# ==============================================================================
# ENDPOINTS
# ==============================================================================

[endpoints.http_api]
service = "http"

[endpoints.http_api.options]
path_prefix = "/"

# ==============================================================================
# BACKENDS
# ==============================================================================

[backends.backend_server]
service = "http"
target_ref = "local_test_server"  # Uses target definition from config.toml
