# FHIR to HTTP API Pipeline (Reverse Flow)
#
# This pipeline demonstrates accepting FHIR bundles from clients,
# validating them as AU eRequesting compliant, and converting them
# to simplified HTTP API calls for a backend service.
#
# Request flow:
#   POST /fhir (FHIR Bundle - AU eRequesting)
#   ↓ (validate FHIR endpoint accepts bundles)
#   ↓ (transform via fhir-to-api-request.json)
#   POST HTTP API request to backend
#   ↓ (backend creates order and returns response)
#   HTTP API response with order details
#

[pipelines.fhir_to_api]
description = "POST FHIR Bundle → converts to HTTP API call"
networks = ["http_net"]
endpoints = ["fhir_bundle_endpoint"]
middleware.left = [
    "validate_fhir_bundle",
    "extract_api_request",
    "dump_api_request",
]
middleware.right = [
    "dump_api_response",
]
backends = ["api_backend"]

# ========================
# Endpoints
# ========================

[endpoints.fhir_bundle_endpoint]
service = "fhir"
[endpoints.fhir_bundle_endpoint.options]
# Accept FHIR bundle POST requests
path_prefix = "/fhir"

# ========================
# Backends
# ========================

[backends.api_backend]
service = "http"
target_ref = "api_server"
[backends.api_backend.options]
# Will POST the transformed request to http://127.0.0.1:8889/orders

# ========================
# Middleware - Left Side (Request Processing)
# ========================

# Validate that incoming FHIR bundle is AU eRequesting compliant
[middleware.validate_fhir_bundle]
type = "log_dump"
[middleware.validate_fhir_bundle.options]
label = "received_fhir_bundle"
pretty = true

# Transform FHIR Bundle to simplified HTTP API request
[middleware.extract_api_request]
type = "transform"
[middleware.extract_api_request.options]
spec_path = "fhir-to-api-request.json"
fail_on_error = false

# Debug: log the API request before sending to backend
[middleware.dump_api_request]
type = "log_dump"
[middleware.dump_api_request.options]
label = "api_request_to_backend"
pretty = true

# ========================
# Middleware - Right Side (Response Processing)
# ========================

# Debug: log the API response
[middleware.dump_api_response]
type = "log_dump"
[middleware.dump_api_response.options]
label = "api_response_from_backend"
pretty = true
