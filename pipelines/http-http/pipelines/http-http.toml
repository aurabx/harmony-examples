# ------------------------
# HTTP Backend Pipeline
# Demonstrates HTTP passthrough to external service
#-------------------------
[pipelines.http_proxy]
description = "HTTP proxy to external backend service with comprehensive access control"
networks = ["http_net"]
endpoints = ["proxy_endpoint"]
middleware = [
    "access_control",
    "passthru",
]
backends = ["external_api"]

# ------------------------
# Middleware
#-------------------------

# Access Control Policies (References policies by ID)
# Production-grade security for HTTP proxy with path filtering and rate limiting
[middleware.access_control]
type = "policies"

[middleware.access_control.options]
policies = ["http_proxy_security"]

# ------------------------
# Policies
#-------------------------
[policies.http_proxy_security]
id = "http_proxy_security"
name = "HTTP Proxy Security"
enabled = true
rules = ["internal_networks", "deny_admin_paths", "rate_limit", "method_filter"]

# ------------------------
# Rules
#-------------------------
[rules.internal_networks]
id = "internal_networks"
name = "Allow Internal Networks Only"
type = "ip_allow"
weight = 90
enabled = true

[rules.internal_networks.options]
ip_addresses = [
    "10.0.0.0/8",       # Private network - Class A
    "172.16.0.0/12",    # Private network - Class B
    "192.168.0.0/16",   # Private network - Class C
    "127.0.0.1/32"      # Localhost
]

[rules.deny_admin_paths]
id = "deny_admin_paths"
name = "Block Admin Paths"
type = "path"
weight = 95
enabled = true

[rules.deny_admin_paths.options]
paths = [
    "/admin/{*path}",
    "/internal/{*path}",
]
mode = "deny"

[rules.rate_limit]
id = "rate_limit"
name = "Rate Limit 100/minute"
type = "rate_limit"
weight = 50
enabled = true

[rules.rate_limit.options]
max_requests = 100
window_seconds = 60

[rules.method_filter]
id = "method_filter"
name = "Allow Standard HTTP Methods"
type = "method"
weight = 80
enabled = true

[rules.method_filter.options]
mode = "allow"
methods = ["GET", "POST", "PUT", "DELETE"]

# Path filtering strategy:
# - Specific deny rules (weight 95) are evaluated before base allow (weight 100)
# - Requests to /admin/* or /internal/* are blocked (403 Forbidden)
# - All other paths are allowed through to the backend
# - This implements a "deny by exception" security model

[middleware.passthru]
type = "passthru"

# ------------------------
# Public endpoints
#-------------------------
[endpoints.proxy_endpoint]
service = "http"
[endpoints.proxy_endpoint.options]
path_prefix = "/"

# ------------------------
# Backends - External HTTP service
#-------------------------
[backends.external_api]
service = "http"
target_ref = "local_server"
[backends.external_api.options]
# base_url is optional if target_ref is used, but can override or augment
# If target has base_path, it is used. If options has base_url, it might be preferred by service implementation
# For HTTP service, we now support constructing URL from connection config.
