# ------------------------
# Multi-Content-Type Pipeline
# Demonstrates handling of JSON, XML, CSV, form data, multipart, and binary content
#-------------------------
[pipelines.multi_content]
description = "Handles JSON, XML, CSV, form data, multipart, and binary content with rate limiting and content-type validation"
networks = ["default"]
endpoints = ["content_handler"]
backends = ["echo_backend"]
middleware = ["content_security"]

# ------------------------
# Middleware
#-------------------------

# Security Policies (References policies by ID)
# Production-grade access control for public content-type demonstration API
# This example shows PUBLIC access with rate limiting and content-type validation
[middleware.content_security]
type = "policies"

[middleware.content_security.options]
policies = ["content_type_security"]

# ------------------------
# Policies
#-------------------------
[policies.content_type_security]
id = "content_type_security"
name = "Content Type Security (Public API)"
enabled = true
rules = ["allow_public", "rate_limit", "content_type_filter", "method_filter"]

# ------------------------
# Rules
#-------------------------
[rules.allow_public]
id = "allow_public"
name = "Allow Public Access"
type = "ip_allow"
weight = 100
enabled = true

[rules.allow_public.options]
ip_addresses = [
    "0.0.0.0/0",  # Allow all IPv4 addresses
]

[rules.rate_limit]
id = "rate_limit"
name = "Rate Limit 200/minute"
type = "rate_limit"
weight = 50
enabled = true

[rules.rate_limit.options]
max_requests = 200
window_seconds = 60

[rules.content_type_filter]
id = "content_type_filter"
name = "Allow Supported Content Types"
type = "content_type"
weight = 80
enabled = true

[rules.content_type_filter.options]
mode = "allow"
content_types = [
    "application/json",                  # JSON data
    "application/xml",                   # XML data
    "text/xml",                          # Alternative XML content-type
    "text/csv",                          # CSV data
    "multipart/form-data",               # File uploads
    "application/x-www-form-urlencoded", # Form submissions
    "text/plain",                        # Plain text
]

[rules.method_filter]
id = "method_filter"
name = "Allow GET and POST Only"
type = "method"
weight = 85
enabled = true

[rules.method_filter.options]
mode = "allow"
methods = ["GET", "POST"]

# Public API security rationale:
# - PUBLIC ACCESS: Allow all IPs (0.0.0.0/0) for demonstration purposes
# - Rate limiting prevents abuse (200 requests/minute per IP)
# - Content-Type validation ensures only supported formats
# - Method restrictions (GET/POST) align with content demo API
#
# Example scenarios:
# ✅ POST /api from any IP with application/json → ALLOWED
# ✅ POST /api with text/csv → ALLOWED
# ✅ POST /api with multipart/form-data → ALLOWED
# ❌ POST /api with application/octet-stream → DENIED (content-type not in allowlist)
# ❌ DELETE /api → DENIED (method not allowed)
# ❌ 201st request in 60 seconds from same IP → DENIED (rate limit exceeded)

# ------------------------
# Endpoints
#-------------------------
[endpoints.content_handler]
service = "http"

[endpoints.content_handler.options]
path_prefix = "/api"

# ------------------------
# Backends
#-------------------------
[backends.echo_backend]
service = "http"
target_ref = "httpbin"  # Uses target definition from config.toml
