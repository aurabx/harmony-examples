[
  {
    "comment": "Extract patient data from webhook payload",
    "operation": "shift",
    "spec": {
      "data": {
        "id": "id",
        "external_id": "id",
        "patient_id": "id",
        "name": "full_name",
        "full_name": "full_name",
        "first_name": "given_name",
        "given_name": "given_name",
        "last_name": "family_name",
        "family_name": "family_name",
        "email": "telecom[0].value",
        "phone": "telecom[1].value",
        "mobile": "telecom[1].value",
        "dob": "birthDate",
        "date_of_birth": "birthDate",
        "birth_date": "birthDate",
        "gender": "gender",
        "sex": "gender"
      },
      "event": "event_type",
      "event_type": "event_type",
      "timestamp": "timestamp",
      "source": "source_system"
    }
  },
  {
    "comment": "Parse full name if given/family not provided",
    "operation": "modify-overwrite-beta",
    "spec": {
      "name_parts": "=split(' ', @(1,full_name))"
    }
  },
  {
    "comment": "Build FHIR Patient structure",
    "operation": "shift",
    "spec": {
      "id": "identifier[0].value",
      "given_name": "name[0].given[0]",
      "family_name": "name[0].family",
      "birthDate": "birthDate",
      "gender": "gender",
      "telecom": {
        "*": {
          "value": "telecom[&1].value"
        }
      },
      "source_system": "meta.source",
      "timestamp": "meta.lastUpdated"
    }
  },
  {
    "comment": "Add FHIR Patient defaults and metadata",
    "operation": "default",
    "spec": {
      "resourceType": "Patient",
      "meta": {
        "profile": [
          "http://hl7.org/fhir/StructureDefinition/Patient"
        ]
      },
      "identifier": [
        {
          "system": "http://webhook.source/patient-id",
          "type": {
            "coding": [
              {
                "system": "http://terminology.hl7.org/CodeSystem/v2-0203",
                "code": "MR"
              }
            ]
          }
        }
      ],
      "name": [
        {
          "use": "official"
        }
      ],
      "telecom": [
        {
          "system": "email",
          "use": "home"
        },
        {
          "system": "phone",
          "use": "mobile"
        }
      ],
      "active": true
    }
  }
]
