# ------------------------
# High-Performance JMIX endpoint configuration
# This example shows how to configure default skip flags in the config file
#-------------------------
[pipelines.jmix_performance]
description = "High-performance JMIX API with security policies for package downloads"
networks = ["http_net"]
endpoints = ["jmix_api_performance"]
middleware = [
    "jmix_builder",
    "package_security",
]
backends = ["dicom_pacs"]

# ------------------------
# Middleware
#-------------------------
[middleware.jmix_builder]
type = "jmix_builder"
[middleware.jmix_builder.options]
# Performance optimization flags configured on the middleware
skip_hashing = true   # Skip SHA256 hashing by default for faster processing
skip_listing = false  # Still include file listings by default for inventory

# Package Download Security Policies (References policies by ID)
# Production-grade access control for JMIX package distribution (read-only API)
[middleware.package_security]
type = "policies"

[middleware.package_security.options]
policies = ["jmix_security"]

# ------------------------
# Policies
#-------------------------
[policies.jmix_security]
id = "jmix_security"
name = "JMIX Package Security"
enabled = true
rules = ["internal_networks", "rate_limit", "method_filter"]

# ------------------------
# Rules
#-------------------------
[rules.internal_networks]
id = "internal_networks"
name = "Allow Internal Networks Only"
type = "ip_allow"
weight = 90
enabled = true

[rules.internal_networks.options]
ip_addresses = [
    "10.0.0.0/8",       # Private network - Class A
    "172.16.0.0/12",    # Private network - Class B
    "192.168.0.0/16",   # Private network - Class C
    "127.0.0.1/32"      # Localhost
]

[rules.rate_limit]
id = "rate_limit"
name = "Rate Limit 30/minute (Package Downloads)"
type = "rate_limit"
weight = 50
enabled = true

[rules.rate_limit.options]
max_requests = 30
window_seconds = 60

[rules.method_filter]
id = "method_filter"
name = "Allow GET Only (Read-Only API)"
type = "method"
weight = 85
enabled = true

[rules.method_filter.options]
mode = "allow"
methods = ["GET"]

# JMIX API security rationale:
# - Read-only API (GET only) - no modifications to packages
# - Lower rate limits (30/min) for large package downloads
# - IP allowlisting restricts access to trusted networks
# - Typical access patterns:
#   * GET /jmix/api/jmix?studyInstanceUid=... (query for packages)
#   * GET /jmix/api/jmix/{id} (download package ZIP)
#   * GET /jmix/api/jmix/{id}/manifest (fetch manifest)
# - All package access should be logged for audit trails

# ------------------------
# JMIX HTTP endpoint
# Routes:
#   GET  /jmix/api/jmix?studyInstanceUid=...     -> triggers DICOM backend if not cached
#   GET  /jmix/api/jmix/{id}                     -> download stored envelope (zip/gzip via Accept)
#   GET  /jmix/api/jmix/{id}/manifest            -> fetch stored manifest.json
#
# Note: Performance options (skip_hashing, skip_listing) are configured on the
# jmix_builder middleware above, not on the endpoint.
#-------------------------
[endpoints.jmix_api_performance]
service = "jmix"
[endpoints.jmix_api_performance.options]
path_prefix = "/jmix"
# Performance optimization flags
skip_hashing = true   # Skip SHA256 hashing for faster processing
skip_listing = true   # Skip DICOM files from files.json manifest

# Optional: custom storage directory
# store_dir = "./tmp/jmix-store-performance"

# ------------------------
# DICOM backend (remote PACS)
#-------------------------
[backends.dicom_pacs]
service = "dicom_scu"
target_ref = "orthanc"        # Uses target definition from config.toml
[backends.dicom_pacs.options]
aet = "ORTHANC"              # Remote AE (Orthanc)
local_aet = "HARMONY_SCU"    # Our AE title
# DICOM retrieval mode: "get" (default) or "move"
# - "get" (C-GET): Works without PACS-side AE configuration, images received directly
# - "move" (C-MOVE): Requires PACS to know SCU's AE title and network address
dimse_retrieve_mode = "get"
incoming_store_port = 11112  # Port Orthanc will push C-STORE to
persistent_store_scp = true  # keep a persistent C-STORE SCP listening