# ------------------------
# Endpoint groups
#-------------------------
[pipelines.fhir]
description = "FHIR API with healthcare-grade security policies (HIPAA-aligned)"
networks = ["http_net"]
endpoints = ["fhir_test"]
middleware = [
    "healthcare_policies",
]
backends = ["fhir_backend"]

# ------------------------
# Middleware
#-------------------------

# Healthcare Security Policies (References policies by ID)
# Production-grade access control aligned with HIPAA and healthcare compliance requirements
# Note: Bearer token authentication is configured at the target level (see config.toml)
[middleware.healthcare_policies]

[middleware.healthcare_policies.options]
policies = ["fhir_security"]

# ------------------------
# Endpoints
#-------------------------
[endpoints.fhir_test]
service = "fhir"
[endpoints.fhir_test.options]
path_prefix = "/fhir"

# ------------------------
# Backends
#-------------------------
[backends.fhir_backend]
service = "fhir"
target_ref = "fire_ly_fhir"  # Uses target definition from config.toml

# Top-level policies
[policies.fhir_security]
id = "fhir_security"
name = "FHIR Healthcare Security"
enabled = true
rules = [
    "healthcare_networks",
    "fhir_resource_paths",
    "rate_limit",
    "method_filter",
]

# Top-level rules
[rules.healthcare_networks]
id = "healthcare_networks"
name = "Allow Healthcare Networks Only"
type = "ip_allow"
weight = 95
enabled = true

[rules.healthcare_networks.options]
ip_addresses = [
    "10.0.0.0/8",       # Private network - Class A (hospital internal)
    "172.16.0.0/12",    # Private network - Class B (clinic networks)
    "192.168.0.0/16",   # Private network - Class C (office networks)
    "127.0.0.1/32"      # Localhost (development/testing)
]

[rules.fhir_resource_paths]
id = "fhir_resource_paths"
name = "Allow FHIR Resource Paths Only"
type = "path"
weight = 90
enabled = true

[rules.fhir_resource_paths.options]
paths = [
    "/metadata",                  # Capability statement
    "/Patient/{*path}",           # Patient demographics
    "/Observation/{*path}",       # Clinical observations
    "/ImagingStudy/{*path}",      # Imaging studies
    "/DiagnosticReport/{*path}",  # Diagnostic reports
    "/Practitioner/{*path}",      # Healthcare providers
    "/Organization/{*path}",      # Healthcare organizations
    "/Encounter/{*path}",         # Patient encounters
    "/Condition/{*path}",         # Patient conditions
    "/Medication/{*path}",        # Medication resources
    "/AllergyIntolerance/{*path}",# Allergy information
]
mode = "allow"

[rules.rate_limit]
id = "rate_limit"
name = "Rate Limit 50/minute (Healthcare)"
type = "rate_limit"
weight = 50
enabled = true

[rules.rate_limit.options]
max_requests = 50
window_seconds = 60

[rules.method_filter]
id = "method_filter"
name = "Allow FHIR CRUD Methods"
type = "method"
weight = 85
enabled = true

[rules.method_filter.options]
mode = "allow"
methods = ["GET", "POST", "PUT", "DELETE"]

