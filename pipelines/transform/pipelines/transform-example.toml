# ------------------------
# Transform Middleware Example
#-------------------------
# ------------------------
# Pipeline with Transform
#-------------------------
[pipelines.transform_demo]
description = "JOLT transform middleware with security policies for transformation endpoint"
networks = ["http_net"]
endpoints = ["http_endpoint"]
middleware = [
    "transform_security",
    "json_extractor",
    "patient_transform",
]
backends = ["echo_backend"]

# ------------------------
# Middleware
#-------------------------

# Transformation Endpoint Security Policies (References policies by ID)
# Production-grade access control for data transformation API (POST-only, JSON input)
[middleware.transform_security]
type = "policies"

[middleware.transform_security.options]
policies = ["transform_security"]

# ------------------------
# Policies
#-------------------------
[policies.transform_security]
id = "transform_security"
name = "Transform Endpoint Security"
enabled = true
rules = ["internal_networks", "rate_limit", "method_filter", "content_type_filter"]

# ------------------------
# Rules
#-------------------------
[rules.internal_networks]
id = "internal_networks"
name = "Allow Internal Networks Only"
type = "ip_allow"
weight = 90
enabled = true

[rules.internal_networks.options]
ip_addresses = [
    "10.0.0.0/8",       # Private network - Class A
    "172.16.0.0/12",    # Private network - Class B
    "192.168.0.0/16",   # Private network - Class C
    "127.0.0.1/32"      # Localhost
]

[rules.rate_limit]
id = "rate_limit"
name = "Rate Limit 50/minute"
type = "rate_limit"
weight = 50
enabled = true

[rules.rate_limit.options]
max_requests = 50
window_seconds = 60

[rules.method_filter]
id = "method_filter"
name = "Allow POST Only (Transformation Endpoint)"
type = "method"
weight = 85
enabled = true

[rules.method_filter.options]
mode = "allow"
methods = ["POST"]

[rules.content_type_filter]
id = "content_type_filter"
name = "Allow JSON Only"
type = "content_type"
weight = 80
enabled = true

[rules.content_type_filter.options]
mode = "allow"
content_types = ["application/json"]

# Transform endpoint security rationale:
# - POST-only API (submit data for transformation, not retrieval)
# - JSON-only content type (required for JOLT transformations)
# - IP allowlisting restricts access to trusted networks
# - Rate limiting prevents abuse of transformation resources
# - Transformation specs are configured server-side (spec_path)
# - Client submits data, receives transformed result

[middleware.json_extractor]
type = "json_extractor"

[middleware.patient_transform]
type = "transform"
[middleware.patient_transform.options]
spec_path = "patient_to_fhir.json"
apply = "left"
fail_on_error = true

# ------------------------
# Endpoints
#-------------------------
[endpoints.http_endpoint]
service = "http"
[endpoints.http_endpoint.options]
path_prefix = "/transform"

# ------------------------
# Backends
#-------------------------
[backends.echo_backend]
service = "echo"

